<html>
  <head>
    <meta charset="utf-8" />
    <title>Generation de QR-codes pour cartes</title>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.min.js"></script>
    <script type="text/javascript" src="html2pdf.js"></script>
    <script type="text/javascript" src="jspdf.min.js"></script>
  </head>
  <body>
    <table>
      <tr><th>Uploader CSV de noms</th><th>Generer un pdf</th></tr>
      <tr>
        <td><input type="file" id="input" onchange="handleFiles(this.files)"></td>
        <td><button onclick="generate_pdf()">Generer le PDF</button></td>
      </tr>
    </table>
    <br/>
    <table id="input_names" border="1px" cellpadding="10px"></table>

    <script type="text/javascript">

    function canvas2img(canvasID) {
      var canvas = document.getElementById(canvasID);
      var ctx = canvas.getContext("2d");
      ctx.font = "16px Arial";
      ctx.fillText(line,8,20);
      canvas.setAttribute("style", "display: none;")
      var img    = canvas.toDataURL("image/png");
      canvas.insertAdjacentHTML("afterend","<img src=\""+img+"\"/>")
    }

    function printCSV(text) {
      innerHTML = ""
      lines = text.split('\n')
      for (var i = 0; i < lines.length; i++) {
        line = lines[i]
        if (line != "") {
          innerHTML += "<tr><td colspan=2>"
          innerHTML += "<canvas id=\"canvas-" + i + "\" width=\"140\" height=\"30\"></td></tr>"
          innerHTML += "<tr><td><div id=\"qrcode1-" + i + "\"></div></td>"
          innerHTML += "<td><div id=\"qrcode2-" + i + "\"></div></td></tr>"
        }
      }
      document.getElementById("input_names").innerHTML = innerHTML
      for (var i = 0; i < lines.length; i++) {
        line = lines[i]
        if (line != "") {
          canvas2img("canvas-" + i)
          var qrcode1 = new QRCode(document.getElementById("qrcode1-" + i), {
            width : 50,
            height : 50
          });
          var qrcode2 = new QRCode(document.getElementById("qrcode2-" + i), {
            width : 50,
            height : 50
          });
          qrcode1.makeCode(line)
          qrcode2.makeCode(line)
        }
      }
    }

    function handleFiles(files) {
      console.log(files[0])
      var reader = new FileReader();
      var res = null
      reader.onload = function(e) {
        printCSV(reader.result)
      }
      reader.readAsText(files[0])
    }

    function generate_pdf() {
      var pdf = new jsPDF('p', 'pt', 'a4');
      pdf.canvas.height = 72 * 11;
      pdf.canvas.width = 72 * 8.5;
      html2pdf(document.getElementById("input_names").outerHTML, pdf, function(pdf){
        var iframe = document.createElement('iframe');
        iframe.setAttribute('style','position:absolute;right:0; top:0; bottom:0; height:100%; width:500px');
        document.body.appendChild(iframe);
        iframe.src = pdf.output('datauristring');
      });
      doc.save('a4.pdf')
    }
    </script>
  </body>
</html>
